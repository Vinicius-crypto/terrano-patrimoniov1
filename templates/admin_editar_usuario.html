{% extends "base.html" %}

{% block title %}Editar UsuÃ¡rio - {{ usuario.username }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold text-gray-800">âœï¸ Editar UsuÃ¡rio</h1>
        <a href="{{ url_for('admin_usuarios') }}" 
           class="text-blue-600 hover:text-blue-800">â† Voltar para Lista</a>
      </div>
      
      <div class="bg-gray-50 rounded-lg p-4">
        <h2 class="text-lg font-semibold text-gray-800 mb-2">{{ usuario.username }}</h2>
        <div class="text-sm text-gray-600">
          <p>Criado em: {% if usuario.created_at %}{{ usuario.created_at.strftime('%d/%m/%Y Ã s %H:%M') }}{% else %}N/A{% endif %}</p>
          <p>Status atual: 
            {% if usuario.ativo %}
            <span class="text-green-600 font-semibold">âœ… Ativo</span>
            {% else %}
            <span class="text-red-600 font-semibold">âŒ Inativo</span>
            {% endif %}
          </p>
        </div>
      </div>
    </div>

    <!-- FormulÃ¡rio de EdiÃ§Ã£o -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <form method="POST" class="space-y-6">
        
        <!-- Nome Completo -->
        <div>
          <label for="nome_completo" class="block text-sm font-medium text-gray-700 mb-2">
            Nome Completo
          </label>
          <input type="text" 
                 id="nome_completo" 
                 name="nome_completo" 
                 value="{{ usuario.nome_completo or '' }}"
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                 placeholder="Nome completo do usuÃ¡rio">
        </div>

        <!-- NÃ­vel de Acesso -->
        <div>
          <label for="nivel_acesso" class="block text-sm font-medium text-gray-700 mb-2">
            NÃ­vel de Acesso
          </label>
          <select id="nivel_acesso" 
                  name="nivel_acesso" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="1" {% if usuario.nivel_acesso == 1 %}selected{% endif %}>
              ğŸ‘ï¸ NÃ­vel 1 - Visualizador (apenas consulta)
            </option>
            <option value="2" {% if usuario.nivel_acesso == 2 %}selected{% endif %}>
              âœï¸ NÃ­vel 2 - Operador (consulta + ediÃ§Ã£o)
            </option>
            <option value="3" {% if usuario.nivel_acesso == 3 %}selected{% endif %}>
              ğŸ”‘ NÃ­vel 3 - Administrador (acesso total)
            </option>
          </select>
          <p class="text-sm text-gray-500 mt-1">
            Defina o nÃ­vel de permissÃµes do usuÃ¡rio no sistema
          </p>
        </div>

        <!-- Status Ativo -->
        <div>
          <label class="flex items-center">
            <input type="checkbox" 
                   name="ativo" 
                   {% if usuario.ativo %}checked{% endif %}
                   class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span class="text-sm font-medium text-gray-700">UsuÃ¡rio ativo no sistema</span>
          </label>
          <p class="text-sm text-gray-500 mt-1">
            UsuÃ¡rios inativos nÃ£o conseguem fazer login
          </p>
        </div>

        <!-- Reset de Senha -->
        <div class="border-t pt-6">
          <h3 class="text-lg font-medium text-gray-800 mb-4">ğŸ”‘ Resetar Senha</h3>
          
          <div>
            <label for="nova_senha" class="block text-sm font-medium text-gray-700 mb-2">
              Nova Senha (opcional)
            </label>
            <input type="password" 
                   id="nova_senha" 
                   name="nova_senha" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="Digite uma nova senha ou deixe vazio para manter atual">
            <p class="text-sm text-gray-500 mt-1">
              âš ï¸ Deixe vazio para manter a senha atual. Se definir nova senha, o usuÃ¡rio precisarÃ¡ usar esta para fazer login.
            </p>
          </div>
        </div>

        <!-- BotÃµes de AÃ§Ã£o -->
        <div class="flex space-x-4 pt-6 border-t">
          <button type="submit" 
                  class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
            ğŸ’¾ Salvar AlteraÃ§Ãµes
          </button>
          
          <a href="{{ url_for('admin_usuarios') }}" 
             class="flex-1 text-center bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition duration-200">
            âŒ Cancelar
          </a>
        </div>

      </form>
    </div>

    <!-- InformaÃ§Ãµes Adicionais -->
    {% if usuario.username != 'admin' and usuario.username != current_user.username %}
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mt-6">
      <h3 class="text-lg font-medium text-red-800 mb-2">âš ï¸ AÃ§Ãµes Perigosas</h3>
      <p class="text-red-700 text-sm mb-4">
        As aÃ§Ãµes abaixo sÃ£o permanentes e nÃ£o podem ser desfeitas. Use com cuidado!
      </p>
      
      <div class="flex space-x-4">
        <button onclick="resetToDefault('{{ usuario.id }}', '{{ usuario.username }}')" 
                class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded text-sm">
          ğŸ”‘ Reset Senha p/ 123456
        </button>
        
        <button onclick="deleteUser('{{ usuario.id }}', '{{ usuario.username }}')" 
                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">
          ğŸ—‘ï¸ Excluir UsuÃ¡rio
        </button>
      </div>
    </div>
    {% endif %}

  </div>
</div>

<script>
function resetToDefault(userId, username) {
    if (confirm(`Resetar a senha do usuÃ¡rio ${username} para "123456"?`)) {
        fetch(`/admin/usuario/${userId}/resetar_senha`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
            } else {
                alert('Erro: ' + data.error);
            }
        })
        .catch(error => alert('Erro: ' + error));
    }
}

function deleteUser(userId, username) {
    if (confirm(`ATENÃ‡ÃƒO! Excluir permanentemente o usuÃ¡rio ${username}? Esta aÃ§Ã£o NÃƒO pode ser desfeita!`)) {
        if (confirm(`ConfirmaÃ§Ã£o final: Realmente excluir ${username}?`)) {
            fetch(`/admin/usuario/${userId}/excluir`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = '{{ url_for("admin_usuarios") }}';
                } else {
                    alert('Erro: ' + data.error);
                }
            })
            .catch(error => alert('Erro: ' + error));
        }
    }
}
</script>
{% endblock %}