<!-- Template: consulta.html com ResponsÃ¡vel como destaque -->
{% extends "base.html" %}
{% block title %}Consulta de Equipamentos{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow mt-6">
  <h2 class="text-2xl font-semibold mb-6 text-center">Consulta de Equipamentos</h2>

  <form method="post" class="flex flex-col sm:flex-row gap-3 mb-6">
    <input type="text" name="busca" placeholder="Buscar..." value="{{ busca or '' }}" class="flex-grow border border-gray-300 rounded px-4 py-2" />
    <button type="submit" class="bg-green-800 text-white px-4 py-2 rounded hover:bg-green-900">Buscar</button>
  </form>

  <!-- Cards responsivos para melhor visualizaÃ§Ã£o -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:hidden">
    {% for equipamento in resultados %}
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow p-4">
      <div class="flex justify-between items-start mb-3">
        <div class="flex-1">
          <h3 class="font-bold text-lg text-green-800">{{ equipamento.id_publico }}</h3>
          <p class="text-sm text-gray-600">{{ equipamento.tipo }}</p>
          {% if equipamento.categoria %}
            <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mt-1">{{ equipamento.categoria }}</span>
          {% endif %}
        </div>
        <div class="flex space-x-2">
          {% if equipamento.termo_pdf_path and equipamento.termo_pdf_path != 'None' %}
            <a href="{{ url_for('ver_termo', id_publico=equipamento.id_publico) }}" target="_blank" class="text-green-600 hover:text-green-800" title="Ver Termo">ğŸ“„</a>
          {% else %}
            <a href="{{ url_for('upload_termo', id_publico=equipamento.id_publico) }}" class="text-gray-400 hover:text-gray-600" title="Upload Termo">ğŸ“„</a>
          {% endif %}
          {% if current_user.is_authenticated and current_user.is_admin %}
            <a href="{{ url_for('editar_equipamento', id_publico=equipamento.id_publico) }}" class="text-blue-600 hover:text-blue-800" title="Editar">âœï¸</a>
          {% endif %}
        </div>
      </div>
      
      <div class="space-y-2 text-sm">
        <div><strong>ResponsÃ¡vel:</strong> {{ equipamento.responsavel or 'N/A' }}</div>
        <div><strong>LocalizaÃ§Ã£o:</strong> {{ equipamento.localizacao }}</div>
        <div><strong>Status:</strong> 
          <span class="inline-block px-2 py-1 rounded text-xs
            {% if equipamento.status == 'Em uso' %}bg-green-100 text-green-800
            {% elif equipamento.status == 'Estocado' %}bg-gray-100 text-gray-800
            {% elif equipamento.status == 'ManutenÃ§Ã£o' %}bg-red-100 text-red-800
            {% endif %}">
            {{ equipamento.status }}
          </span>
        </div>
        <div><strong>Marca/Modelo:</strong> {{ equipamento.marca }} {{ equipamento.modelo }}</div>
        {% if equipamento.centro_custo %}
          <div><strong>Centro de Custo:</strong> {{ equipamento.centro_custo }}</div>
        {% endif %}
        {% if equipamento.garantia_ate %}
          <div><strong>Garantia atÃ©:</strong> {{ equipamento.garantia_ate.strftime('%d/%m/%Y') }}</div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Tabela para telas maiores -->
  <div class="hidden md:block overflow-x-auto">
    <table class="w-full text-sm border-collapse">
      <thead class="bg-gray-100 text-left">
        <tr>
          <th class="border px-3 py-2">ID PÃºblico</th>
          <th class="border px-3 py-2">Tipo/Categoria</th>
          <th class="border px-3 py-2">ResponsÃ¡vel ğŸ‘¤</th>
          <th class="border px-3 py-2">LocalizaÃ§Ã£o</th>
          <th class="border px-3 py-2">Status</th>
          <th class="border px-3 py-2">Marca/Modelo</th>
          <th class="border px-3 py-2">Centro de Custo</th>
          <th class="border px-3 py-2">Garantia</th>
          <th class="border px-3 py-2">Termo</th>
          {% if current_user.is_authenticated and current_user.is_admin %}
          <th class="border px-3 py-2">AÃ§Ãµes</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for equipamento in resultados %}
        <tr class="hover:bg-gray-50">
          <td class="border px-3 py-2 font-semibold text-green-700">{{ equipamento.id_publico }}</td>
          <td class="border px-3 py-2">
            {{ equipamento.tipo }}
            {% if equipamento.categoria %}
              <br><small class="text-gray-500">{{ equipamento.categoria }}</small>
            {% endif %}
          </td>
          <td class="border px-3 py-2 font-medium">{{ equipamento.responsavel or 'N/A' }}</td>
          <td class="border px-3 py-2">{{ equipamento.localizacao }}</td>
          <td class="border px-3 py-2">
            <span class="inline-block px-2 py-1 rounded text-xs
              {% if equipamento.status == 'Em uso' %}bg-green-100 text-green-800
              {% elif equipamento.status == 'Estocado' %}bg-gray-100 text-gray-800
              {% elif equipamento.status == 'ManutenÃ§Ã£o' %}bg-red-100 text-red-800
              {% endif %}">
              {{ equipamento.status }}
            </span>
          </td>
          <td class="border px-3 py-2">{{ equipamento.marca }}<br><small>{{ equipamento.modelo }}</small></td>
          <td class="border px-3 py-2">{{ equipamento.centro_custo or '-' }}</td>
          <td class="border px-3 py-2">
            {% if equipamento.garantia_ate %}
              {% set dias_restantes = (equipamento.garantia_ate - datetime.now().date()).days %}
              <span class="text-xs {% if dias_restantes < 30 %}text-red-600{% elif dias_restantes < 90 %}text-orange-600{% else %}text-green-600{% endif %}">
                {{ equipamento.garantia_ate.strftime('%d/%m/%Y') }}
                {% if dias_restantes > 0 %}
                  <br>({{ dias_restantes }} dias)
                {% else %}
                  <br>(Expirada)
                {% endif %}
              </span>
            {% else %}
              <span class="text-gray-400">N/A</span>
            {% endif %}
          </td>
          <td class="border px-3 py-2 text-center">
            <div class="flex justify-center space-x-1">
              <!-- Gerar Novo Termo -->
              <button onclick="gerarTermo('{{ equipamento.id_publico }}')" class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded text-xs bg-blue-50 hover:bg-blue-100" title="Gerar Termo de Cautela">
                ğŸ“„ Gerar
              </button>
              
              {% if equipamento.termo_pdf_path and equipamento.termo_pdf_path != 'None' %}
                <!-- Ver Termo Existente -->
                <a href="{{ url_for('ver_termo', id_publico=equipamento.id_publico) }}" target="_blank" class="text-green-600 hover:text-green-800 px-2 py-1 rounded text-xs bg-green-50 hover:bg-green-100" title="Ver Termo">
                  ğŸ‘ï¸ Ver
                </a>
                <!-- Substituir Termo -->
                <a href="{{ url_for('upload_termo', id_publico=equipamento.id_publico) }}" class="text-yellow-600 hover:text-yellow-800 px-2 py-1 rounded text-xs bg-yellow-50 hover:bg-yellow-100" title="Upload Novo">
                  ğŸ” Upload
                </a>
              {% else %}
                <!-- Upload Termo -->
                <a href="{{ url_for('upload_termo', id_publico=equipamento.id_publico) }}" class="text-gray-600 hover:text-gray-800 px-2 py-1 rounded text-xs bg-gray-50 hover:bg-gray-100" title="Upload Termo">
                  â¬†ï¸ Upload
                </a>
              {% endif %}
            </div>
          </td>
          {% if current_user.is_authenticated and current_user.is_admin %}
          <td class="border px-3 py-2 text-center">
            <a href="{{ url_for('editar_equipamento', id_publico=equipamento.id_publico) }}" class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded text-xs bg-blue-50 hover:bg-blue-100" title="Editar Equipamento">
              âœï¸ Editar
            </a>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
function gerarTermo(idPublico) {
    // Mostrar loading
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = 'â³ Gerando...';
    button.disabled = true;
    
    // Fazer requisiÃ§Ã£o para gerar PDF com dados do equipamento
    fetch(`/gerar_termo_cautela/${idPublico}`, {
        method: 'GET'
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Erro ao gerar termo de cautela');
    })
    .then(blob => {
        // Download do PDF
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `termo_cautela_${idPublico}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Mostrar sucesso
        button.innerHTML = 'âœ… Gerado!';
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        }, 2000);
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('âŒ Erro ao gerar termo de cautela. Tente novamente.');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
</script>
{% endblock %}
